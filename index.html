<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Registro de Inventario</title>

<!-- Fuente moderna -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f3f5f7;
    display: flex;
    justify-content: center;
    padding: 30px;
  }

  .container {
    width: 100%;
    max-width: 420px;
    background: white;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  h2 {
    text-align: center;
    font-weight: 600;
    padding-bottom: 10px;
    color: #333;
  }

  label {
    font-weight: 500;
    margin-top: 12px;
    display: block;
    color: #444;
  }

  input, select {
    width: 100%;
    padding: 12px;
    margin-top: 5px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background: #fafafa;
    font-size: 15px;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #4a90e2;
    background: white;
  }

  button {
    width: 100%;
    padding: 14px;
    background: #4a90e2;
    color: white;
    border: none;
    font-size: 16px;
    margin-top: 20px;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.25s;
  }

  button:hover {
    background: #3578c6;
  }

  .alert {
    margin-top: 18px;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    font-weight: 500;
  }

  .ok {
    background: #d9f7e3;
    color: #1c7e36;
  }

  .error {
    background: #ffd8d8;
    color: #b30000;
  }
</style>
</head>

<body>

<div class="container">
  <h2>üì¶ Movimiento de Inventario</h2>

  <label>C√≥digo QR del Estante</label>
  <input id="qr" placeholder="SHELF-001">

  <label>N√∫mero de Factura</label>
  <input id="factura" placeholder="000123">

  <label>Cantidad</label>
  <input id="cantidad" type="number" min="0">

  <label>Tipo de Movimiento</label>
  <select id="tipo">
    <option value="ENT">Entrada</option>
    <option value="SAL">Salida</option>
    <option value="AJU">Ajuste</option>
  </select>

  <label>Usuario</label>
  <input id="usuario" placeholder="Nombre del empleado">

  <label>Notas</label>
  <input id="notas" placeholder="Opcional">

  <button onclick="guardar()">Registrar Movimiento</button>

  <div id="msg"></div>
</div>

<script>
/* ==============================
   CONFIGURACI√ìN SUPABASE
============================== */
const SUPABASE_URL = "https://rwsbibdoakugyvunljir.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3c2JpYmRvYWt1Z3l2dW5samlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzE1NDcsImV4cCI6MjA4MDIwNzU0N30.8u6ZFVR4GqtUpv7B1t9bCE1em5Pq8UBnVrUVA0_ktAk";

/* ==============================
   AUTO-RELLENAR EL QR DESDE LA URL
   Ejemplo: ?qr=SHELF-001
============================== */
const urlParams = new URLSearchParams(window.location.search);
const qrFromURL = urlParams.get("qr");
if (qrFromURL) {
  document.getElementById("qr").value = qrFromURL;
}

/* ==============================
   FUNCI√ìN PARA GUARDAR MOVIMIENTO
============================== */
async function guardar() {
  const qr = document.getElementById("qr").value.trim();
  const factura = document.getElementById("factura").value.trim();
  const cantidad = Number(document.getElementById("cantidad").value);
  const tipo = document.getElementById("tipo").value;
  const usuario = document.getElementById("usuario").value.trim();
  const notas = document.getElementById("notas").value.trim();
  const msg = document.getElementById("msg");

  msg.innerHTML = "";

  if (!qr || !cantidad || !usuario) {
    msg.innerHTML = "<div class='alert error'>Completa los campos obligatorios.</div>";
    return;
  }

  /* ==============================
     1. BUSCAR EL ESTANTE
  ============================== */
  const estanteRes = await fetch(
    `${SUPABASE_URL}/rest/v1/estante?codigo_qr=eq.${qr}`,
    {
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": "Bearer " + SUPABASE_KEY
      }
    }
  );

  const estantes = await estanteRes.json();

  if (estantes.length === 0) {
    msg.innerHTML = "<div class='alert error'>‚ùå El c√≥digo QR no existe en la base de datos.</div>";
    return;
  }

  const estante = estantes[0];

  /* ==============================
     2. INSERTAR MOVIMIENTO
  ============================== */
  const resp = await fetch(
    `${SUPABASE_URL}/rest/v1/movimiento_inventario`,
    {
      method: "POST",
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": "Bearer " + SUPABASE_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        producto_id: estante.producto_id,
        estante_id: estante.estante_id,
        tipo_movimiento: tipo,
        cantidad: cantidad,
        factura: factura,
        usuario: usuario,
        notas: notas
      })
    }
  );

  if (resp.ok) {
    msg.innerHTML = "<div class='alert ok'>‚úî Movimiento registrado correctamente</div>";
    
    // limpiar campos
    document.getElementById("cantidad").value = "";
    document.getElementById("factura").value = "";
    document.getElementById("notas").value = "";

  } else {
    msg.innerHTML = "<div class='alert error'>‚ùå Error al guardar el movimiento</div>";
  }
}
</script>

</body>
</html>
